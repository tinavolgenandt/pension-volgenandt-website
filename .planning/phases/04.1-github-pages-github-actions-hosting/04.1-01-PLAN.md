---
phase: 04.1-github-pages-github-actions-hosting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
  - package.json
  - app/components/contact/Form.vue
  - app/app.config.ts
autonomous: true
user_setup:
  - service: github-pages
    why: "Static site hosting"
    dashboard_config:
      - task: "Set GitHub Pages source to GitHub Actions"
        location: "GitHub repo > Settings > Pages > Build and deployment > Source > select 'GitHub Actions'"

must_haves:
  truths:
    - "A GitHub Actions workflow file exists that builds the site with the github_pages Nitro preset on every push to main"
    - "The contact form submits to Formspree via AJAX POST instead of Netlify Forms (placeholder ID -- account created later)"
    - "The Formspree form ID is configurable via app.config.ts, not hardcoded in component code"
    - "pnpm install succeeds on Ubuntu CI without contradictory built-dependency directives"
    - "The site deploys to standard github.io URL with correct baseURL for repo subpath"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "CI/CD pipeline for GitHub Pages deployment"
      contains: "github_pages"
    - path: "app/components/contact/Form.vue"
      provides: "Formspree-powered contact form (placeholder ID)"
      contains: "formspree.io"
    - path: "app/app.config.ts"
      provides: "Formspree form ID configuration"
      contains: "formspreeId"
    - path: "package.json"
      provides: "Clean pnpm config without contradictory directives"
      contains: "onlyBuiltDependencies"
  key_links:
    - from: "app/components/contact/Form.vue"
      to: "app/app.config.ts"
      via: "useAppConfig().formspreeId"
      pattern: "useAppConfig.*formspreeId"
    - from: ".github/workflows/deploy.yml"
      to: ".output/public"
      via: "nuxt build --preset github_pages"
      pattern: "github_pages"
    - from: ".github/workflows/deploy.yml"
      to: "actions/deploy-pages@v4"
      via: "deploy job"
      pattern: "deploy-pages"
---

<objective>
Create the GitHub Actions deployment workflow, fix pnpm config for CI compatibility, and migrate the contact form from Netlify Forms to Formspree.

Purpose: This plan produces all the code and configuration needed for GitHub Pages deployment and a working contact form. After this plan, the only remaining steps are human-only actions (configuring GitHub Pages source in repo settings and creating the Formspree account).

Output: GitHub Actions workflow YAML, CNAME file, cleaned package.json, updated contact form component, updated app config.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-github-pages-github-actions-hosting/04.1-RESEARCH.md
@app/components/contact/Form.vue
@app/app.config.ts
@nuxt.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix pnpm config, create GitHub Actions workflow and CNAME file</name>
  <files>.github/workflows/deploy.yml, public/CNAME, package.json</files>
  <action>
**Step 0 -- Fix pnpm config for CI compatibility:**
Open `package.json` and verify the `pnpm` config block. If `better-sqlite3` appears in BOTH `onlyBuiltDependencies` AND `ignoredBuiltDependencies`, remove the `ignoredBuiltDependencies` array entirely -- these are contradictory directives that cause `pnpm install` to fail on Ubuntu CI. The final `pnpm` config must contain ONLY `onlyBuiltDependencies`:

```json
"pnpm": {
  "onlyBuiltDependencies": [
    "better-sqlite3"
  ]
}
```

If `ignoredBuiltDependencies` is already absent, no change is needed -- just confirm the config is clean.

**Step 1 -- Create the GitHub Actions workflow:**
Create the GitHub Actions workflow file at `.github/workflows/deploy.yml` with a two-job pipeline (build + deploy):

**Build job (ubuntu-latest):**
1. `actions/checkout@v4`
2. `pnpm/action-setup@v4` with version 10
3. `actions/setup-node@v4` with node-version 20 and cache 'pnpm'
4. `pnpm install` (dependencies)
5. `pnpm nuxt build --preset github_pages` (NOT `pnpm generate` -- the preset creates `.nojekyll` and `404.html` automatically)
6. `actions/upload-pages-artifact@v3` with path `./.output/public`

**Deploy job:**
- `needs: build`
- `permissions: pages: write, id-token: write`
- `environment: name: github-pages, url: ${{ steps.deployment.outputs.page_url }}`
- `actions/deploy-pages@v4` with id `deployment`

**Workflow triggers:**
- `workflow_dispatch` (manual trigger)
- `push` to `main` branch

**Concurrency control:**
- `group: pages`
- `cancel-in-progress: false`

**Step 2 -- Create CNAME file:**
Create `public/CNAME` containing exactly one line: `www.pension-volgenandt.de` (no trailing newline, no other content). This file gets copied to `.output/public/CNAME` at build time, ensuring the custom domain persists across deployments.

**Note on path:** `public/CNAME` is at the project root, NOT at `app/public/CNAME`. In Nuxt 4, the `public/` directory remains at the project root even when using the `app/` directory convention. All existing static assets (favicon.ico, img/, video/) confirm this location.

**Important:** Do NOT use `nuxt generate` anywhere. The `github_pages` Nitro preset via `nuxt build --preset github_pages` is the correct command.
  </action>
  <verify>
1. Verify no contradictory pnpm config: `grep "ignoredBuiltDependencies" package.json` returns no match
2. Verify onlyBuiltDependencies is present: `grep "onlyBuiltDependencies" package.json` returns a match
3. Verify workflow file exists: `cat .github/workflows/deploy.yml` -- should contain `github_pages`, `deploy-pages@v4`, `pnpm/action-setup@v4`
4. Verify CNAME: `cat public/CNAME` -- should contain exactly `www.pension-volgenandt.de`
5. Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))"` or visually confirm proper indentation
  </verify>
  <done>
- `package.json` pnpm config is clean: only `onlyBuiltDependencies` present (no `ignoredBuiltDependencies`)
- `.github/workflows/deploy.yml` exists with correct two-job workflow structure
- `public/CNAME` contains `www.pension-volgenandt.de`
- Workflow triggers on push to main and manual dispatch
- Build job uses `pnpm nuxt build --preset github_pages`
- Deploy job uses `actions/deploy-pages@v4` with correct permissions
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate contact form from Netlify Forms to Formspree</name>
  <files>app/components/contact/Form.vue, app/app.config.ts</files>
  <action>
**Update `app/app.config.ts`:**
Add a `formspreeId` field at the top level of the config object. Use `'xPLACEHOLDER'` as the initial value with a comment explaining it must be replaced with the real form ID from formspree.io. Example:

```typescript
formspreeId: 'xPLACEHOLDER', // Replace with real Formspree form ID from https://formspree.io
```

**Rewrite `app/components/contact/Form.vue` submission logic:**

1. Remove all Netlify-specific code:
   - Remove the hidden `<form name="kontakt" data-netlify="true" ... hidden>` element entirely
   - Remove `data-netlify="true"` and `data-netlify-honeypot="bot-field"` from the visible form
   - Remove `<input type="hidden" name="form-name" value="kontakt" />`
   - Remove the Netlify honeypot `<div class="hidden"><input name="bot-field" /></div>`

2. Add Formspree honeypot:
   - Add `<input type="text" name="_gotcha" style="display: none" tabindex="-1" autocomplete="off" />` inside the form (hidden from users, catches bots)

3. Rewrite `handleSubmit()`:
   - Get form ID from `useAppConfig()`: `const appConfig = useAppConfig()`
   - Use `fetch` instead of `$fetch` to POST to `https://formspree.io/f/${appConfig.formspreeId}`
   - Send JSON body with `Content-Type: application/json` and `Accept: application/json` headers
   - Send `{ name: formData.name, email: formData.email, message: formData.message }`
   - On success (`response.ok`): set `isSubmitted.value = true`
   - On error: parse `response.json()` for `data.errors` array, join error messages; fall back to generic German error message
   - On network error (catch): show generic German error message

4. Keep ALL existing UI unchanged:
   - Keep success state (`v-if="isSubmitted"`)
   - Keep all form field labels, inputs, styling classes
   - Keep the submit button with loading state
   - Keep the error message display

**Do NOT:**
- Change any CSS classes or visual styling
- Change form field names, labels, or validation
- Remove the success state or error display
- Hardcode the Formspree form ID in the component (use `useAppConfig()`)
  </action>
  <verify>
1. `grep -c "netlify" app/components/contact/Form.vue` returns 0 (no Netlify references remain)
2. `grep "formspree.io" app/components/contact/Form.vue` returns a match
3. `grep "formspreeId" app/app.config.ts` returns a match
4. `grep "_gotcha" app/components/contact/Form.vue` returns a match (honeypot present)
5. `grep "useAppConfig" app/components/contact/Form.vue` returns a match
6. Run `pnpm nuxi typecheck` -- should pass with no type errors
  </verify>
  <done>
- Contact form POSTs to Formspree endpoint using form ID from app.config.ts
- All Netlify Forms attributes and hidden forms removed
- Formspree `_gotcha` honeypot field present
- Form ID is configurable (not hardcoded in component)
- All existing UI, styling, and validation preserved
- TypeScript type check passes
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm nuxi typecheck` -- no type errors
2. Run `pnpm nuxt build --preset github_pages` -- build succeeds and `.output/public/` directory contains site files, `.nojekyll`, `404.html`, and `CNAME`
3. Verify `.output/public/CNAME` contains `www.pension-volgenandt.de`
4. Verify `.output/public/.nojekyll` exists (created by preset)
5. Verify no Netlify references remain: `grep -r "netlify" app/components/contact/` returns no matches
6. Verify no `ignoredBuiltDependencies` in package.json
</verification>

<success_criteria>
- GitHub Actions workflow at `.github/workflows/deploy.yml` with build + deploy pipeline
- CNAME file at `public/CNAME` for custom domain
- package.json pnpm config clean (no contradictory directives)
- Contact form migrated from Netlify Forms to Formspree with configurable form ID
- Local build with `github_pages` preset succeeds and produces correct output structure
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-github-pages-github-actions-hosting/04.1-01-SUMMARY.md`
</output>
