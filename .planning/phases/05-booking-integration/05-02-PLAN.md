---
phase: 05-booking-integration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/composables/useBeds24Prices.ts
  - server/utils/beds24Api.ts
  - server/api/prices.get.ts
  - nuxt.config.ts
  - app/components/rooms/Card.vue
  - app/components/rooms/PriceTable.vue
  - app/pages/zimmer/[slug].vue
  - app/pages/zimmer/index.vue
  - .github/workflows/deploy.yml
  - app/components/booking/Beds24Widget.vue
autonomous: false

user_setup:
  - service: beds24-api
    why: "Live pricing from Beds24 API V2 requires authentication tokens"
    env_vars:
      - name: BEDS24_REFRESH_TOKEN
        source: "Beds24 Control Panel > Settings > Account > API V2 > Generate invite code > Exchange for refresh token via POST https://beds24.com/api/v2/authentication/setup (see https://wiki.beds24.com/index.php/Category:API_V2)"
    dashboard_config:
      - task: "Generate an API V2 invite code with 'properties' scope"
        location: "Beds24 Control Panel > Settings > Account > API V2"
      - task: "Add BEDS24_REFRESH_TOKEN as a GitHub Actions repository secret"
        location: "GitHub repo > Settings > Secrets and variables > Actions > New repository secret"
      - task: "Confirm actual Beds24 room IDs for Pension Volgenandt rooms (Balkonzimmer, Rosengarten, Wohlfuhl-Appartement) and update YAML files"
        location: "Beds24 Control Panel > Properties > Pension Volgenandt > Rooms (note the numeric room IDs)"

must_haves:
  truths:
    - "Room cards on /zimmer/ show live Beds24 prices when available, with YAML fallback price shown with 'ab' prefix when API unreachable"
    - "Room detail pages show live prices from Beds24 in the price display area"
    - "Build-time price fetching runs as part of GitHub Actions deploy workflow using BEDS24_REFRESH_TOKEN secret"
    - "API tokens are never exposed in client-side JavaScript bundles"
    - "Price loading shows a subtle loading state then smoothly replaces YAML price with live price"
  artifacts:
    - path: "app/composables/useBeds24Prices.ts"
      provides: "Client-side composable that reads build-time-fetched prices from a JSON data file"
      min_lines: 20
    - path: "server/utils/beds24Api.ts"
      provides: "Server-side Beds24 API V2 client for build-time token refresh + price fetching"
      min_lines: 40
    - path: "server/api/prices.get.ts"
      provides: "Nitro API route that fetches prices at build time and serves static JSON"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "server/utils/beds24Api.ts"
      via: "BEDS24_REFRESH_TOKEN env var passed to build"
      pattern: "BEDS24_REFRESH_TOKEN"
    - from: "app/composables/useBeds24Prices.ts"
      to: "Build-time generated price data"
      via: "Fetches pre-built price JSON via Nuxt $fetch (baseURL-aware) or uses YAML fallback"
      pattern: "useBeds24Prices|priceData"
    - from: "app/components/rooms/Card.vue"
      to: "app/composables/useBeds24Prices.ts"
      via: "getPrice(slug) replaces startingPrice with live Beds24 price"
      pattern: "useBeds24Prices|getPrice"
---

<objective>
Add live Beds24 pricing to room cards and detail pages with YAML fallback.

Purpose: Show visitors accurate, up-to-date room prices sourced from the Beds24 booking system (the single source of truth for pricing). When the Beds24 API is unreachable or tokens are not configured, YAML prices display with an "ab" (starting from) prefix. This ensures pricing is always visible while being as accurate as possible.

Output: Build-time price fetching via Beds24 API V2, client-side price display composable with fallback, updated room cards and detail pages with live pricing, GitHub Actions workflow integration with API secret.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-booking-integration/05-CONTEXT.md
@.planning/phases/05-booking-integration/05-RESEARCH.md
@.planning/phases/05-booking-integration/05-01-SUMMARY.md
@content.config.ts
@app/components/rooms/Card.vue
@app/components/rooms/PriceTable.vue
@app/pages/zimmer/[slug].vue
@app/pages/zimmer/index.vue
@.github/workflows/deploy.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build-time Beds24 price fetching + client-side price display</name>
  <files>
    server/utils/beds24Api.ts
    server/api/prices.get.ts
    nuxt.config.ts
    app/composables/useBeds24Prices.ts
    app/components/rooms/Card.vue
    app/components/rooms/PriceTable.vue
    app/pages/zimmer/[slug].vue
    app/pages/zimmer/index.vue
    .github/workflows/deploy.yml
    app/components/booking/Beds24Widget.vue
  </files>
  <action>
**FILE GROUPING (3 concern areas -- work in this order):**
- **Group A: Server infrastructure** -- `server/utils/beds24Api.ts`, `server/api/prices.get.ts`, `nuxt.config.ts` (runtimeConfig + prerender route)
- **Group B: Client composable** -- `app/composables/useBeds24Prices.ts`
- **Group C: UI wiring** -- `app/components/rooms/Card.vue`, `app/components/rooms/PriceTable.vue`, `app/pages/zimmer/[slug].vue`, `app/pages/zimmer/index.vue`, `.github/workflows/deploy.yml`, `app/components/booking/Beds24Widget.vue`

**CRITICAL CONTEXT.md decisions:**
- "Beds24 is the source of truth for pricing and availability"
- "Show Beds24 live prices everywhere (room cards, detail pages), not just in booking widget"
- "Fallback strategy: Show YAML price immediately on page load, silently replace with Beds24 live price once fetched client-side. If API unreachable, YAML price persists with 'ab' (starting from) prefix"
- "API tokens MUST NOT be exposed in client-side code"
- "For build-time price fetching: token stored as GitHub Actions secret"

**Strategy: Build-Time Price Fetching**

Since the site is SSG on GitHub Pages (no server-side runtime), and API tokens can't be in client code, the approach is:

1. During `nuxt build` in GitHub Actions, a Nitro server route fetches prices from Beds24 API V2
2. The fetched prices are written to a static JSON file in the build output
3. Client-side composable reads this pre-built JSON file
4. If the JSON file is missing or prices are stale, YAML prices persist with "ab" prefix

This avoids: client-side token exposure, runtime API calls, serverless proxy complexity.

**1. Create `server/utils/beds24Api.ts`:**

Beds24 API V2 client for build-time use. Functions:
- `getAccessToken(refreshToken: string): Promise<string>` -- POST to `https://beds24.com/api/v2/authentication/token` with refresh token header, returns 24h access token
- `getProperties(accessToken: string): Promise<Property[]>` -- GET `https://beds24.com/api/v2/properties` to get all properties with rooms and pricing info
- `getRoomPrices(accessToken: string, propertyId: number, roomId?: number): Promise<PriceData>` -- GET `https://beds24.com/api/v2/inventory/rooms/calendar` with date range (today + 90 days) to get per-day pricing

Use native `fetch()` (available in Node.js 18+ used by Nitro). No external SDK needed -- the API is simple REST.

API auth header format: `{ 'token': accessToken }`

Price data structure to extract:
```typescript
interface Beds24PriceData {
  fetchedAt: string // ISO timestamp
  rooms: Record<string, { // keyed by slug
    minPrice: number // lowest available price per night
    maxPrice: number // highest price per night
    currency: 'EUR'
    available: boolean // whether room has any availability
  }>
}
```

**2. Create `server/api/prices.get.ts`:**

A Nitro API route that:
- Reads `BEDS24_REFRESH_TOKEN` from `process.env` (or `useRuntimeConfig()`)
- If token is missing, returns empty/null response (graceful degradation)
- Calls beds24Api to get access token, then fetch prices for all 3 properties
- Maps room data to the slug-keyed format
- Returns JSON response

This route is called during SSG prerender. Add `/api/prices` to `nitro.prerender.routes` in nuxt.config.ts so it's pre-rendered as a static JSON file.

Add `runtimeConfig` to nuxt.config.ts:
```typescript
runtimeConfig: {
  beds24RefreshToken: '', // Set via BEDS24_REFRESH_TOKEN env var
}
```

**3. Create `app/composables/useBeds24Prices.ts`:**

Client-side composable that:
- On mount, fetches the pre-built `/api/prices` endpoint (which is a static JSON file after SSG) using Nuxt's `$fetch('/api/prices')` or `useFetch('/api/prices')` -- NOT native `fetch()`. This is critical because Nuxt's fetch utilities automatically apply the `app.baseURL` prefix, which is required for GitHub Pages subpath deployment (e.g., `/pension-volgenandt-website/api/prices` instead of `/api/prices`). Using native `fetch('/api/prices')` would 404 in production.
- Provides a reactive `getPrice(slug: string)` function
- Returns `{ price: number | null, isLive: boolean, isLoading: boolean }`
- `isLive: true` when Beds24 price is available, `false` when showing YAML fallback
- When price is not live (YAML fallback), the "ab" prefix should be shown

Cache the fetched data in a module-level variable so multiple components don't re-fetch.

**4. Update price displays:**

Update `app/components/rooms/Card.vue`:
- Import and use `useBeds24Prices()`
- Add `slug` to the existing props (it's already passed but might need to be used for price lookup)
- Show live price when available, YAML `startingPrice` with "ab" prefix as fallback
- Add a subtle loading shimmer/pulse while price loads (use Tailwind animate-pulse on a small area)

Update `app/components/rooms/PriceTable.vue`:
- If live price data is available, show a note like "Aktuelle Preise laut Buchungssystem" above the table
- The PriceTable continues to show YAML pricing structure (periods, occupancy rates) since Beds24 API doesn't provide the same breakdown

Update `app/pages/zimmer/[slug].vue`:
- Show the live price prominently near the booking section (if consent granted)
- Or near the title area (visible regardless of consent)

Update `app/pages/zimmer/index.vue`:
- RoomCard components already show starting price -- the Card component update handles this

**5. Update GitHub Actions workflow (`.github/workflows/deploy.yml`):**

Add `BEDS24_REFRESH_TOKEN` env var to the build step:
```yaml
- name: Build
  run: pnpm build --preset github_pages
  env:
    NUXT_APP_BASE_URL: /${{ github.event.repository.name }}/
    BEDS24_REFRESH_TOKEN: ${{ secrets.BEDS24_REFRESH_TOKEN }}
```

This makes the token available to Nitro during build without ever exposing it in client bundles.

**6. Update Beds24Widget.vue (from Plan 05-01):**

If the widget component from Plan 05-01 has any price display, integrate the live price there too. Otherwise, no changes needed.

**Graceful degradation chain:**
1. BEDS24_REFRESH_TOKEN not set -> API route returns null -> all prices are YAML fallback with "ab"
2. Token set but API error -> same graceful fallback
3. Token set, API works -> live prices shown without "ab" prefix
4. Pre-built JSON missing on client -> YAML prices persist
5. URL resolution: Must use Nuxt's `$fetch()` (not native `fetch()`) so `app.baseURL` is applied for GitHub Pages subpath deployment

This means the site works perfectly without the Beds24 API token -- the owner can set it up later.

  </action>
  <verify>
1. Run `pnpm build` WITHOUT BEDS24_REFRESH_TOKEN set -- build succeeds, /api/prices returns empty/null
2. Visit room pages -- YAML prices shown with "ab" prefix (fallback mode)
3. Set BEDS24_REFRESH_TOKEN env var, run build -- /api/prices returns live price data
4. Visit room pages -- live prices shown without "ab" prefix
5. Room cards on /zimmer/ show live prices when available
6. Check client JS bundle -- no API token present in any .js file
  </verify>
  <done>
- Build-time price fetching from Beds24 API V2 works when token is configured
- Graceful fallback to YAML prices with "ab" prefix when token missing or API error
- Room cards show live prices from Beds24
- Room detail pages show live prices
- API tokens never appear in client-side code
- GitHub Actions workflow passes token as build env var
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Beds24 booking integration: JavaScript widgets on room detail pages (BookingBox + AvailabilityCalendar), consent-gated loading, live pricing with YAML fallback, conversion-optimized room cards.
  </what-built>
  <how-to-verify>
1. Run `pnpm dev` and open the site
2. **Without consent:** Visit /zimmer/emils-kuhwiese -- verify NO booking widget, NO requests to beds24.com in Network tab
3. **Grant consent:** Open Cookie Settings, enable "Buchung", save
4. **With consent:** Visit /zimmer/emils-kuhwiese -- verify:
   - Booking section appears after gallery, before amenities
   - BookingBox widget renders with date picker and guest selector
   - AvailabilityCalendar shows color-coded dates
   - Clicking "Buchen" opens beds24.com in a new tab
5. **Room overview:** Visit /zimmer/ -- verify room cards have prominent CTAs and pricing
6. **Mobile:** Check responsive layout of booking widgets on mobile viewport
7. **Other rooms:** Visit /zimmer/balkonzimmer, /zimmer/schoene-aussicht -- widgets load with correct property/room IDs
8. **Pricing:** Room cards show "ab XX EUR" (YAML fallback if no API token) or live price
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with and without BEDS24_REFRESH_TOKEN
2. Site functions correctly in both consent states (granted/not granted)
3. Live prices appear when API token is configured
4. YAML prices with "ab" prefix appear when API token is missing
5. No API tokens in client-side JavaScript bundles
6. GitHub Actions workflow supports BEDS24_REFRESH_TOKEN secret
7. All room pages render booking widgets correctly with their respective property/room IDs
</verification>

<success_criteria>
- Build-time price fetching from Beds24 API V2 works with proper token
- Graceful degradation: YAML prices + "ab" prefix when token missing
- Room cards show live Beds24 prices on /zimmer/ overview
- Room detail pages show live prices
- API tokens never exposed in client bundles
- GitHub Actions deploy workflow passes token as env var
- Human verification approves the complete booking integration UX
</success_criteria>

<output>
After completion, create `.planning/phases/05-booking-integration/05-02-SUMMARY.md`
</output>
