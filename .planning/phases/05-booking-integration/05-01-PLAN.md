---
phase: 05-booking-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/booking/Beds24Widget.vue
  - app/components/booking/Beds24Calendar.vue
  - app/composables/useBeds24Widget.ts
  - app/composables/useCookieConsent.ts
  - app/components/CookieConsent.vue
  - app/components/CookieSettings.vue
  - app/pages/zimmer/[slug].vue
  - app/pages/zimmer/index.vue
  - app/components/rooms/Card.vue
  - app/pages/datenschutz.vue
  - nuxt.config.ts
autonomous: true

must_haves:
  truths:
    - "Visitor who grants booking consent sees Beds24 BookingBox widget on room detail pages with availability calendar and date picker, pre-filtered to that room's property/room ID"
    - "Visitor who has NOT granted booking consent sees NO booking widget area at all -- zero requests to beds24.com or media.xmlcal.com in Network tab"
    - "[OVERRIDES BOOK-02] No BookingConsentPlaceholder component exists -- widget area is completely absent from DOM when consent not granted (per CONTEXT.md: 'hidden entirely, not a placeholder card')"
    - "Cookie consent banner/settings include Buchung category with toggle switch, consistent with existing media toggle"
    - "Room detail page shows booking section after gallery but before amenities/description, following CONTEXT.md layout order"
    - "Rooms not in Beds24 (Doppelzimmer, Einzelzimmer with placeholder IDs) show phone booking CTA instead of widget"
    - "BookingBox form opens Beds24 responsive booking page (booking2.php) in a new tab"
  artifacts:
    - path: "app/components/booking/Beds24Widget.vue"
      provides: "Consent-gated Beds24 BookingBox JS widget wrapper"
      min_lines: 40
    - path: "app/components/booking/Beds24Calendar.vue"
      provides: "Consent-gated Beds24 AvailabilityCalendar JS widget"
      min_lines: 30
    - path: "app/composables/useBeds24Widget.ts"
      provides: "Script loading composable for bookWidget.min.js with consent check"
      min_lines: 20
    - path: "app/pages/zimmer/[slug].vue"
      provides: "Room detail page with booking section positioned after gallery, before amenities"
  key_links:
    - from: "app/components/booking/Beds24Widget.vue"
      to: "useCookieConsent"
      via: "isAllowed('booking') controls v-if rendering"
      pattern: "isAllowed.*booking"
    - from: "app/composables/useBeds24Widget.ts"
      to: "https://media.xmlcal.com/widget/1.00/js/bookWidget.min.js"
      via: "Dynamic script injection after consent"
      pattern: "media\\.xmlcal\\.com.*bookWidget"
    - from: "app/pages/zimmer/[slug].vue"
      to: "app/components/booking/Beds24Widget.vue"
      via: "Room data passes beds24PropertyId/beds24RoomId to widget"
      pattern: "beds24PropertyId|beds24RoomId"
---

<objective>
Integrate Beds24 JavaScript booking widgets into the site with DSGVO-compliant consent gating.

Purpose: Enable visitors to check room availability and initiate bookings directly from room detail pages. This is the core conversion flow -- the primary reason visitors come to the site. Widgets are consent-gated so zero requests to Beds24 servers occur before the visitor grants booking consent.

Output: Beds24Widget (BookingBox), Beds24Calendar (AvailabilityCalendar), useBeds24Widget composable, updated consent system with Buchung toggle, room detail pages with booking section near the top, room cards with more prominent booking CTAs, phone CTA fallback for non-Beds24 rooms.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-booking-integration/05-CONTEXT.md
@.planning/phases/05-booking-integration/05-RESEARCH.md
@app/composables/useCookieConsent.ts
@app/components/CookieConsent.vue
@app/components/CookieSettings.vue
@app/components/attractions/MapConsent.vue
@app/pages/zimmer/[slug].vue
@app/pages/zimmer/index.vue
@app/components/rooms/Card.vue
@content.config.ts
@nuxt.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Beds24 widget loading infrastructure + consent system update</name>
  <files>
    app/composables/useBeds24Widget.ts
    app/components/booking/Beds24Widget.vue
    app/components/booking/Beds24Calendar.vue
    app/components/CookieConsent.vue
    app/components/CookieSettings.vue
    app/pages/datenschutz.vue
    nuxt.config.ts
  </files>
  <action>
**CRITICAL CONTEXT.md OVERRIDES (read first):**
- NO iframes. Use Beds24 JavaScript widgets (BookingBox, AvailabilityCalendar) only.
- NO BookingBar, no sticky bar, no floating button.
- Widget area HIDDEN entirely when consent not granted (v-if, not placeholder card).
- Research file focused on iframes -- IGNORE iframe/iframe-resizer patterns. Use JS widget approach below.

**Beds24 JS Widget System (from research on bookWidget.min.js):**
The Beds24 widget system uses a jQuery plugin loaded from `https://media.xmlcal.com/widget/1.00/js/bookWidget.min.js`. It supports 4 widget types: BookingBox, BookingBoxMini, BookingStrip, AvailabilityCalendar. The plugin initializes via `$('#container').bookWidget({options})`.

Key options:
- `widgetType`: 'BookingBox' | 'BookingBoxMini' | 'BookingStrip' | 'AvailabilityCalendar'
- `ownerid`, `propid`, `roomid`: property/room identifiers
- `formAction`: URL for form submission (default: booking.php, use 'https://beds24.com/booking2.php')
- `formTarget`: '_blank' to open in new tab
- `widgetLang`: 'de' for German
- `dateSelection`: 0=none, 1=checkin only, 2=checkin+checkout, 3=checkin+nights
- `peopleSelection`: 0=none, 1=total, 2=adults+children
- `defaultNumNight`: default night count (use 2)
- `defaultNumAdult`: default adult count (use 2)
- Color options: `color`, `backgroundColor`, `borderColor`, `buttonColor`, `boxShadow`, `boxShadowColor`
- The AvailabilityCalendar type fetches availability data from Beds24 and color-codes dates

The script REQUIRES jQuery. It embeds ~5000 lines of inline CSS. It uses jQuery UI datepicker internally.

**1. Create `app/composables/useBeds24Widget.ts`:**

A composable that handles dynamic loading of the Beds24 widget script + jQuery dependency, but ONLY after booking consent is granted. Pattern:
- Check `isAllowed('booking')` from useCookieConsent
- If not consented, do nothing (no scripts loaded)
- If consented, dynamically inject jQuery (from CDN: `https://code.jquery.com/jquery-3.7.1.min.js` with `integrity='sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo='` and `crossOrigin='anonymous'` for Subresource Integrity) and then `bookWidget.min.js` into the document head
- Return a reactive `isReady` ref that becomes true when both scripts are loaded
- Use a module-level promise to prevent duplicate loading across components
- Guard all logic with `import.meta.client` since this is SSG

Important: jQuery and bookWidget.min.js must be loaded SEQUENTIALLY (jQuery first, then bookWidget). Use promise chaining. The script URLs must ONLY be injected after consent -- this is the DSGVO compliance mechanism.

Do NOT install jQuery via npm. Load it dynamically from CDN only after consent. This keeps the SSG bundle clean and ensures zero third-party requests before consent.

When dynamically creating the jQuery `<script>` element, set `integrity='sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo='` and `crossOrigin='anonymous'` on the element for Subresource Integrity verification.

Add `'https://code.jquery.com'` and `'https://media.xmlcal.com'` and `'https://beds24.com'` to any CSP or external domains if needed in nuxt.config.ts. Update nuxt.config.ts vite.optimizeDeps.include to add any new deps if needed.

**2. Create `app/components/booking/Beds24Widget.vue`:**

A Vue component wrapping the Beds24 BookingBox widget. Props:
- `beds24PropertyId: number` (required)
- `beds24RoomId?: number` (optional -- Ferienwohnungen don't have roomId)
- `roomName: string` (for aria-label)

Behavior:
- Uses `useBeds24Widget()` composable to get `isReady`
- Only renders when booking consent is granted AND script is loaded (double v-if)
- Uses `v-if="isAllowed('booking')"` at the outermost level -- when consent not granted, renders NOTHING (no placeholder, no hint, just absent from DOM per CONTEXT.md)
- When ready, provides a container div with a unique ID (use `useId()` or `ref` + random suffix)
- In `onMounted` (or `watch(isReady)`), initialize the widget: call jQuery plugin on the container

Widget initialization code (inside onMounted/watch):
```typescript
const $ = (window as any).jQuery
if ($ && containerRef.value) {
  $(containerRef.value).bookWidget({
    widgetType: 'BookingBox',
    propid: props.beds24PropertyId,
    ...(props.beds24RoomId ? { roomid: props.beds24RoomId } : {}),
    formAction: 'https://beds24.com/booking2.php',
    formTarget: '_blank', // Opens booking in new tab per CONTEXT.md
    widgetLang: 'de',
    dateSelection: 3, // Check-in + nights dropdown
    peopleSelection: 2, // Adults + children
    defaultNumNight: 2,
    defaultNumAdult: 2,
    // Design system colors (match sage green + waldhonig)
    buttonColor: '#c8913a', // waldhonig-500
    color: '#2d4a3e', // sage-800
    backgroundColor: '#f9f7f4', // warm-white
    borderColor: '#bfc9c3', // sage-300
  })
}
```

Wrap the component usage in `<ClientOnly>` in the parent page (not inside the component itself).

Style the container with Tailwind classes: rounded-lg, p-4/p-6, bg-white border border-sage-200, shadow-sm. Add a heading like "Verf端gbarkeit & Buchung" above the widget.

**3. Create `app/components/booking/Beds24Calendar.vue`:**

Similar to Beds24Widget but uses `widgetType: 'AvailabilityCalendar'`. This shows a color-coded calendar (green=available, red=booked). Same consent gating pattern. Props same as Beds24Widget. Simpler layout -- just the calendar, no form fields.

**4. Update consent system (`CookieConsent.vue` and `CookieSettings.vue`):**

The consent system ALREADY has `booking` in its ConsentPreferences interface and CookieSettings already has a "Buchung" toggle. No structural changes needed to the composable.

CONTEXT.md says: "Expand existing cookie banner with radio/switch buttons for service categories." Currently CookieConsent.vue has only "Nur Notwendige" and "Alle akzeptieren" buttons. The CookieSettings modal has individual toggles.

Minimal update approach: The current CookieConsent banner is fine as-is for TDDDG compliance (equal-prominence accept/reject). The "Buchung" category is already toggleable in CookieSettings. If the executor judges the banner should show individual category toggles inline (not just in the settings modal), add a brief expandable section. But do NOT over-engineer this -- the existing accept-all/reject-all + settings modal pattern is already DSGVO-compliant. The key requirement is that the Buchung toggle exists and works, which it already does in CookieSettings.

The Datenschutzerklarung page at /datenschutz/ should mention the Beds24 booking widget (beds24.com) as a third-party service under the "Buchung" consent category. Add a brief section to the privacy policy about Beds24 data processing. Read the current datenschutz page content and add a "Buchungswidget (Beds24)" subsection in the appropriate location.

  </action>
  <verify>
1. Run `pnpm build` (or `make build`) -- build succeeds with no TypeScript errors
2. Run `pnpm dev` (or `make dev`) and visit a room detail page (e.g., /zimmer/emils-kuhwiese)
3. Before granting consent: verify NO requests to beds24.com, media.xmlcal.com, or code.jquery.com in browser Network tab
4. Open Cookie Settings, enable "Buchung" toggle, save
5. Verify jQuery and bookWidget.min.js are loaded in Network tab
6. Verify BookingBox widget renders on the room page
  </verify>
  <done>
- useBeds24Widget composable dynamically loads jQuery + bookWidget.min.js only after booking consent
- Beds24Widget component renders BookingBox pre-filtered by propid/roomid with form opening in new tab
- Beds24Calendar component renders AvailabilityCalendar with color-coded dates
- Zero requests to external domains before booking consent is granted
- Consent system's existing Buchung toggle correctly controls widget loading
  </done>
</task>

<task type="auto">
  <name>Task 2: Room detail page booking section + room card conversion optimization</name>
  <files>
    app/pages/zimmer/[slug].vue
    app/pages/zimmer/index.vue
    app/components/rooms/Card.vue
  </files>
  <action>
**1. Restructure room detail page (`app/pages/zimmer/[slug].vue`):**

CONTEXT.md says: "Room detail pages: booking section (availability calendar + BookingBox) positioned near the top, after hero image/gallery but before amenities and description."

Current order on the page:
1. Photo Gallery
2. Title & Category
3. Description
4. Amenities
5. Price Table
6. Extras
7. Weitere Zimmer

New order (per CONTEXT.md):
1. Photo Gallery
2. Title & Category
3. **Booking Section (NEW)** -- availability calendar + BookingBox
4. Price Table (moved up -- price info near booking widget helps conversion)
5. Amenities
6. Description
7. Extras
8. Weitere Zimmer

The Booking Section should:
- Be wrapped in `<ClientOnly>` and `v-if="isAllowed('booking')"` -- when consent not granted, this section simply does not exist in the DOM (no placeholder, no gap)
- Use the room's `beds24PropertyId` and `beds24RoomId` from the YAML data
- Display two widgets side by side on desktop (calendar left, booking box right) or stacked on mobile
- Include a section heading like "Verf端gbarkeit & Buchung"
- For rooms where `beds24RoomId` is a placeholder (1-5 for Pension rooms) or where the room may not be in Beds24: use `beds24RoomId` as-is from YAML for now. The CONTEXT.md acknowledges these are placeholders and owner must confirm real IDs. The code should pass whatever is in YAML.
- For rooms WITHOUT `beds24RoomId` (Ferienwohnungen emils-kuhwiese and schoene-aussicht), pass only `beds24PropertyId`
- **Fallback for non-bookable rooms:** If a room has `beds24RoomId` set to a known placeholder value AND is known to not be in Beds24 (Doppelzimmer with roomId 4, Einzelzimmer with roomId 5 -- per research: "Not in booking system?"), show a phone CTA: "Dieses Zimmer ist nur telefonisch buchbar" with click-to-call link using the phone number from app.config.ts. However, since we can't be 100% sure which rooms are in Beds24, the safest approach is: render the widget for ALL rooms that have beds24PropertyId. If the widget fails to load data, Beds24 will show a "no rooms available" message which is acceptable. Only show the phone fallback if beds24PropertyId is missing entirely (which currently never happens in YAML, but defensive coding).

Add the import for `useCookieConsent` and the booking components. The `isAllowed` check should use `import.meta.client` guard similar to MapConsent pattern to prevent SSG hydration mismatches:
```typescript
const { isAllowed } = useCookieConsent()
const isClient = import.meta.client
const showBooking = computed(() => isClient && isAllowed('booking'))
```

**2. Enhance room cards on overview page (`app/components/rooms/Card.vue`):**

CONTEXT.md says: "Room cards and booking widgets on /zimmer/ and room detail pages should be more prominent and conversion-focused."

Current card is a NuxtLink wrapping the whole card. Enhance:
- Add a more prominent CTA button at the bottom of each card (e.g., "Zimmer ansehen" or "Verf端gbarkeit pr端fen") styled with waldhonig-500 (the CTA color)
- Make the starting price more visually prominent (larger font, waldhonig accent color)
- Add a subtle "ab" prefix before the price in a lighter weight
- Keep the card as a NuxtLink (the whole card is clickable) but add the button as a visual affordance

**3. Update room overview page (`app/pages/zimmer/index.vue`):**

Add a brief intro text encouraging visitors to check availability. Optionally add a note about the booking widget being available on individual room pages. Keep it subtle -- the page's primary purpose is room browsing.

  </action>
  <verify>
1. Run `pnpm build` -- build succeeds
2. Visit /zimmer/emils-kuhwiese in dev server -- booking section appears after gallery, before amenities (when consent granted)
3. Visit /zimmer/emils-kuhwiese without consent -- NO booking section visible, no gap or placeholder
4. Visit /zimmer/doppelzimmer -- booking widget attempts to load (or shows phone fallback if beds24PropertyId missing)
5. Visit /zimmer/ -- room cards have more prominent CTAs and pricing
6. Check mobile responsive layout -- booking widgets stack vertically on small screens
  </verify>
  <done>
- Room detail page has booking section positioned after gallery, before amenities (CONTEXT.md layout)
- Booking section is completely absent from DOM when booking consent not granted
- Room cards have more prominent, conversion-focused CTAs and pricing display
- All rooms pass their beds24PropertyId/beds24RoomId to the widget from YAML data
- Phone CTA fallback available for rooms without Beds24 property ID
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with zero errors
2. On any room detail page with booking consent granted:
   - jQuery and bookWidget.min.js loaded dynamically
   - BookingBox widget renders with date picker, guest selector, and "Buchen" button
   - Clicking "Buchen" opens beds24.com/booking2.php in a new tab with correct propid/roomid
3. On any room detail page WITHOUT booking consent:
   - Zero requests to beds24.com, media.xmlcal.com, code.jquery.com
   - No booking section visible in DOM
4. Cookie Settings panel: Buchung toggle works, enabling it triggers widget loading
5. Room overview page: cards show prominent CTAs and pricing
6. Mobile: booking widgets render correctly on small screens
</verification>

<success_criteria>
- Beds24 BookingBox JavaScript widget loads and renders on room detail pages after consent
- AvailabilityCalendar widget shows color-coded dates after consent
- Zero third-party requests before booking consent (DSGVO/TDDDG compliance)
- Booking section positioned after gallery, before amenities on room detail pages
- Widget pre-filtered by room's beds24PropertyId and beds24RoomId from YAML
- Form submission opens Beds24 responsive booking page in new tab
- Room cards on /zimmer/ are more conversion-focused with prominent CTAs
</success_criteria>

<output>
After completion, create `.planning/phases/05-booking-integration/05-01-SUMMARY.md`
</output>
