---
phase: 05-booking-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/booking/BookingWidget.vue
  - app/components/booking/BookingConsentPlaceholder.vue
  - app/pages/zimmer/[slug].vue
  - package.json
autonomous: true

must_haves:
  truths:
    - "Visitor who granted booking consent sees the Beds24 iframe on a room detail page, pre-filtered to that room's property/room ID"
    - 'Visitor who has NOT granted booking consent sees a placeholder with explanation and a button to grant consent -- zero requests to beds24.com in Network tab'
    - 'Beds24 iframe height adjusts dynamically as the visitor navigates booking steps'
    - 'Rooms not in the Beds24 booking system (null beds24PropertyId) show a phone booking CTA instead of a widget'
  artifacts:
    - path: 'app/components/booking/BookingWidget.vue'
      provides: 'Consent-gated Beds24 iframe with iframeResizer initialization'
      contains: 'iframeResize'
    - path: 'app/components/booking/BookingConsentPlaceholder.vue'
      provides: 'Placeholder UI shown when booking consent not granted'
      contains: 'Buchungswidget'
    - path: 'app/pages/zimmer/[slug].vue'
      provides: 'Room detail page with booking section wired in'
      contains: 'BookingWidget'
  key_links:
    - from: 'app/components/booking/BookingWidget.vue'
      to: 'useCookieConsent'
      via: "isAllowed('booking') for consent gating"
      pattern: 'isAllowed.*booking'
    - from: 'app/pages/zimmer/[slug].vue'
      to: 'app/components/booking/BookingWidget.vue'
      via: 'props: beds24PropertyId, beds24RoomId from room YAML data'
      pattern: 'beds24PropertyId'
    - from: 'app/components/booking/BookingWidget.vue'
      to: 'iframe-resizer'
      via: 'iframeResize() called in onMounted on the iframe element'
      pattern: 'iframeResize'
---

<objective>
Install iframe-resizer v4.3.11, create the BookingWidget (consent-gated Beds24 iframe with dynamic height) and BookingConsentPlaceholder components, and wire them into room detail pages.

Purpose: Visitors can check availability and book directly from each room's detail page without leaving the site. This is the core conversion flow -- the entire site funnels toward booking.
Output: Two new components in `app/components/booking/`, updated room detail page with booking section.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-booking-integration/05-RESEARCH.md

# Existing patterns to follow

@app/components/attractions/MapConsent.vue
@app/composables/useCookieConsent.ts
@app/pages/zimmer/[slug].vue
@content/rooms/emils-kuhwiese.yml
@content/rooms/balkonzimmer.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install iframe-resizer and create BookingWidget + BookingConsentPlaceholder</name>
  <files>
    app/components/booking/BookingWidget.vue
    app/components/booking/BookingConsentPlaceholder.vue
    package.json
  </files>
  <action>
    1. Install iframe-resizer pinned to the last MIT version:
       `pnpm add iframe-resizer@4.3.11`
       Verify package.json shows exactly `"iframe-resizer": "4.3.11"` (not ^4.3.11 -- use `--save-exact` or verify the pinned version).

    2. Create `app/components/booking/BookingConsentPlaceholder.vue`:
       - Props: `roomName: string`
       - Follow the MapConsent.vue pattern: show a styled placeholder with explanation text and consent button
       - Use `useCookieConsent()` composable, `updateCategory('booking', true)` to grant booking consent on button click
       - Text: "Zum Laden des Buchungswidgets wird eine Verbindung zu beds24.com hergestellt." with an explanation that personal data may be transmitted
       - CTA button: "Buchungswidget laden" styled with waldhonig-500 bg, matching MapConsent button styling
       - Include a fallback link: `<a href="https://beds24.com/booking2.php?ownerid=135075&lang=de" target="_blank">Direkt auf Beds24 buchen</a>` for users who prefer not to load the iframe
       - Use Phosphor icon `ph:calendar-check-duotone` for visual consistency
       - Wrap in a rounded-lg container with sage-50 bg, border-sage-200 border, centered content, py-12 px-6 min-h-[300px]

    3. Create `app/components/booking/BookingWidget.vue`:
       - Props: `beds24PropertyId: number`, `beds24RoomId?: number`, `roomName: string`
       - Consent check: Use `useCookieConsent()` with `isAllowed('booking')`. Show `BookingConsentPlaceholder` when NOT consented, show iframe when consented. Use `v-if` (NOT `v-show`).
       - URL construction: Build Beds24 URL as a computed:
         - Base: `https://beds24.com/booking2.php`
         - If `beds24RoomId` is present and truthy: use `roomid=X` param (specific room in multi-room property)
         - Else: use `propid=X` param (standalone Ferienwohnung property)
         - Always include: `lang=de`, `referer=iFrame`
       - iframe: Wrap in `<ClientOnly>`. Set `width="100%"`, `scrolling="no"`, `style="border: none; min-height: 600px;"`, `title="Buchung - {roomName}"`.
       - Include an accessible `<p>` fallback inside `<noscript>` or after iframe: `<a :href="bookingUrl">Direkt auf Beds24 buchen</a>`
       - iframeResizer initialization:
         - Import: `import iframeResize from 'iframe-resizer/js/iframeResizer'`
         - In `onMounted()`: call `iframeResize({ checkOrigin: false, scrolling: 'omit', warningTimeout: 20000 }, iframeRef.value)` with a `ref<HTMLIFrameElement | null>(null)` on the iframe
         - In `onBeforeUnmount()`: clean up via `iframeRef.value?.iFrameResizer?.close()` (use optional chaining; type cast as needed)
       - The component is the single entry point -- it handles both consent states internally

    IMPORTANT: For rooms where `beds24PropertyId` is falsy/undefined, the BookingWidget should NOT be rendered at all. The parent page will handle showing a phone CTA instead. The component assumes valid beds24PropertyId when rendered.

  </action>
  <verify>
    - `pnpm ls iframe-resizer` shows 4.3.11
    - `pnpm run typecheck` passes (or has no new errors from booking components)
    - Both .vue files exist in `app/components/booking/`
    - BookingWidget.vue imports iframeResize and calls it in onMounted
    - BookingConsentPlaceholder.vue uses useCookieConsent and updateCategory
    - No direct requests to beds24.com without consent gate (v-if pattern confirmed in source)
  </verify>
  <done>
    BookingWidget and BookingConsentPlaceholder components exist, iframe-resizer v4.3.11 is installed, and consent gating follows the established v-if pattern from MapConsent.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire booking section into room detail page</name>
  <files>
    app/pages/zimmer/[slug].vue
  </files>
  <action>
    Modify `app/pages/zimmer/[slug].vue` to add a booking section after the Extras section (section 6) and before Weitere Zimmer (section 7):

    1. Add a new section between RoomsExtras and RoomsOtherRooms:
       ```
       <!-- 7. Buchung / Booking -->
       <section v-if="room.beds24PropertyId" id="buchung" class="scroll-mt-24">
         <h2 class="mb-6 font-serif text-2xl font-bold text-sage-800">
           Verfuegbarkeit & Buchung
         </h2>
         <BookingWidget
           :beds24-property-id="room.beds24PropertyId"
           :beds24-room-id="room.beds24RoomId"
           :room-name="room.name"
         />
       </section>
       ```

    2. For rooms WITHOUT a beds24PropertyId (if any exist), show a phone booking fallback:
       ```
       <section v-else id="buchung" class="scroll-mt-24">
         <h2 class="...">Buchung</h2>
         <div class="rounded-lg bg-sage-50 border border-sage-200 p-8 text-center">
           <Icon name="ph:phone-duotone" class="mx-auto mb-4 size-12 text-sage-500" />
           <p class="mb-4 text-sage-700">
             Dieses Zimmer kann telefonisch gebucht werden.
           </p>
           <a :href="`tel:${config.contact.phone}`"
              class="inline-flex items-center gap-2 rounded-lg bg-waldhonig-500 px-6 py-3 font-semibold text-white hover:bg-waldhonig-600">
             <Icon name="ph:phone" class="size-5" />
             {{ config.contact.phone }}
           </a>
         </div>
       </section>
       ```
       Use `const config = useAppConfig()` (already available or add it) to get the phone number.

    3. Add `id="buchung"` with `scroll-mt-24` to the booking section so the BookingBar (Plan 05-02) can smooth-scroll to it.

    4. Renumber the existing "Weitere Zimmer" comment from section 7 to section 8.

    IMPORTANT: All 7 room YAML files currently have `beds24PropertyId` set, so the v-if branch will always be taken. The v-else is defensive for future rooms. The `beds24RoomId` is optional -- Ferienwohnungen (emils-kuhwiese, schoene-aussicht) don't have it, and the BookingWidget handles both cases internally.

  </action>
  <verify>
    - `pnpm run typecheck` passes (or has no new errors)
    - `app/pages/zimmer/[slug].vue` contains `BookingWidget` component usage
    - The booking section has `id="buchung"` for scroll targeting
    - `beds24PropertyId` and `beds24RoomId` are passed from room data to BookingWidget
    - Phone fallback exists for rooms without beds24PropertyId
  </verify>
  <done>
    Room detail pages show the consent-gated Beds24 booking widget (or phone fallback) between the extras section and "Weitere Zimmer". The section has an anchor ID for scroll targeting.
  </done>
</task>

</tasks>

<verification>
1. `pnpm ls iframe-resizer` shows version 4.3.11 (pinned, not ^)
2. `pnpm run typecheck` passes with no new errors
3. Visit `/zimmer/emils-kuhwiese/` -- should show BookingConsentPlaceholder (if booking consent not granted) or Beds24 iframe (if granted)
4. Check browser Network tab: no requests to beds24.com before clicking "Buchungswidget laden"
5. After granting consent, iframe loads with correct URL params (propid=257613 for emils-kuhwiese, propid=261258+roomid for pension rooms)
6. Visit `/zimmer/balkonzimmer/` -- iframe URL should include roomid param (placeholder value 2 for now)
</verification>

<success_criteria>

- iframe-resizer v4.3.11 installed and pinned
- BookingWidget renders Beds24 iframe with correct URL params per room
- BookingConsentPlaceholder blocks all beds24.com requests until consent granted
- Room detail pages have booking section with scroll anchor
- Phone fallback exists for rooms without Beds24 IDs
  </success_criteria>

<output>
After completion, create `.planning/phases/05-booking-integration/05-01-SUMMARY.md`
</output>
