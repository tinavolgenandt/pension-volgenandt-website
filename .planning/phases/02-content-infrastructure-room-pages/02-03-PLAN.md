---
phase: 02-content-infrastructure-room-pages
plan: 03
type: execute
wave: 3
depends_on: ['02-01', '02-02']
files_modified:
  - app/composables/useGallery.ts
  - app/components/rooms/Gallery.vue
  - app/components/rooms/Lightbox.vue
  - app/components/rooms/Description.vue
  - app/components/rooms/Amenities.vue
  - app/components/rooms/PriceTable.vue
  - app/components/rooms/Extras.vue
  - app/components/rooms/OtherRooms.vue
  - app/pages/zimmer/[slug].vue
autonomous: false

must_haves:
  truths:
    - 'Visitor clicking a room card reaches a detail page at /zimmer/[slug]'
    - 'Detail page shows photo gallery with hero image and visible thumbnail strip'
    - 'Clicking a gallery image opens a fullscreen lightbox with navigation arrows, thumbnail strip, and keyboard/swipe support'
    - 'Amenity icon grid displays room features with Lucide icons and German labels'
    - "Price table shows per-occupancy rates with 'pro Nacht' unit and 'Alle Preise inkl. MwSt.' notice"
    - 'Extras section lists Zusatzleistungen (Fruehstueck, Hund, BBQ) with prices'
    - "'Weitere Zimmer' section shows all other 6 rooms as compact cards"
    - "All displayed prices include VAT and show 'pro Nacht' unit (PAngV compliance)"
  artifacts:
    - path: 'app/composables/useGallery.ts'
      provides: 'Gallery state management (current image, lightbox open/close, navigation)'
      exports: ['useGallery']
    - path: 'app/components/rooms/Gallery.vue'
      provides: 'Hero image + thumbnail strip with click-to-open-lightbox'
      min_lines: 40
    - path: 'app/components/rooms/Lightbox.vue'
      provides: 'Fullscreen image overlay with focus trap, keyboard nav, swipe'
      min_lines: 60
    - path: 'app/components/rooms/Description.vue'
      provides: 'Short description with Mehr lesen expand'
    - path: 'app/components/rooms/Amenities.vue'
      provides: 'Icon grid with room specs and amenities'
    - path: 'app/components/rooms/PriceTable.vue'
      provides: 'Seasonal pricing table with PAngV compliance'
    - path: 'app/components/rooms/Extras.vue'
      provides: 'Zusatzleistungen list with prices'
    - path: 'app/components/rooms/OtherRooms.vue'
      provides: 'Weitere Zimmer grid using compact RoomsCard'
    - path: 'app/pages/zimmer/[slug].vue'
      provides: 'Room detail page assembling all components'
      contains: 'queryCollection'
  key_links:
    - from: 'app/pages/zimmer/[slug].vue'
      to: "queryCollection('rooms')"
      via: 'Nuxt Content query with slug filter'
      pattern: "queryCollection\\(['\"]rooms['\"]\\).*where.*slug"
    - from: 'app/components/rooms/Gallery.vue'
      to: 'app/composables/useGallery.ts'
      via: 'composable import'
      pattern: 'useGallery'
    - from: 'app/components/rooms/Lightbox.vue'
      to: 'useFocusTrap'
      via: 'VueUse integration'
      pattern: 'useFocusTrap'
    - from: 'app/components/rooms/Lightbox.vue'
      to: 'useSwipe'
      via: 'VueUse core'
      pattern: 'useSwipe'
    - from: 'app/components/rooms/Amenities.vue'
      to: 'app/utils/amenities.ts'
      via: 'amenityMap import'
      pattern: 'amenityMap'
    - from: 'app/components/rooms/OtherRooms.vue'
      to: 'app/components/rooms/Card.vue'
      via: 'compact card variant'
      pattern: '<RoomsCard'
---

<objective>
Build the room detail page (`/zimmer/[slug]`) with photo gallery, lightbox, amenity icons, pricing table, extras, expandable description, and "Weitere Zimmer" cross-links. This is the core product page where visitors decide to book.

Purpose: The detail page is the conversion-critical page. Visitors need to see photos, understand amenities, compare prices, and easily navigate to other rooms. Every element directly supports the booking decision.
Output: Complete room detail page with 8 custom components and 1 composable, rendering full room data from YAML.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-infrastructure-room-pages/02-RESEARCH.md
@.planning/phases/02-content-infrastructure-room-pages/02-CONTEXT.md
@.planning/phases/02-content-infrastructure-room-pages/02-01-SUMMARY.md
@.planning/phases/02-content-infrastructure-room-pages/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gallery composable, Gallery, Lightbox, and simple detail components</name>
  <files>
    app/composables/useGallery.ts
    app/components/rooms/Gallery.vue
    app/components/rooms/Lightbox.vue
    app/components/rooms/Description.vue
    app/components/rooms/Amenities.vue
  </files>
  <action>
**1. Create `app/composables/useGallery.ts`**

A composable managing gallery state. Follow the research Pattern 4 implementation:

- Accepts `images: Ref<{ src: string; alt: string }[]>`
- Exposes: `currentIndex` (readonly ref), `currentImage` (computed), `isLightboxOpen` (readonly ref), `hasNext`, `hasPrev`, `goTo(index)`, `next()`, `prev()`, `openLightbox(index?)`, `closeLightbox()`
- Navigation bounds-checks: `goTo` clamps to 0..length-1, `next`/`prev` only move if possible
- Export the `GalleryImage` interface: `{ src: string; alt: string }`

**2. Create `app/components/rooms/Gallery.vue`**

Hero image + thumbnail strip component. Receives `heroImage`, `heroImageAlt`, and `gallery` array as props.

Implementation:

- Combine heroImage with gallery into a single `allImages` computed array (hero first, then gallery items)
- Use `useGallery(allImages)` composable for state
- Hero area: Large image display using `<NuxtImg>` with `loading="eager"` and `fetchpriority="high"` (this is the LCP element). Use `sizes="100vw"` for full-width. Aspect ratio `aspect-[16/9]` or `aspect-[3/2]` container. Click opens lightbox at current index.
- Thumbnail strip below hero: Show ALL thumbnails (never truncate -- CONTEXT.md locked decision). Each ~100-120px wide on desktop. Use `<NuxtImg>` with `loading="lazy"`, `width="120"`, `height="80"`. Active thumbnail has highlighted border. Click changes hero and opens lightbox.
- On mobile: Thumbnails in a horizontal scrollable row (`overflow-x-auto flex gap-2`)
- Include the Lightbox component with `<ClientOnly>` wrapper to avoid hydration mismatches

**3. Create `app/components/rooms/Lightbox.vue`**

Fullscreen image overlay. Follow research Pattern 4 lightbox implementation closely.

Props: `images: GalleryImage[]`, `currentIndex: number`, `isOpen: boolean`
Emits: `close`, `navigate: [index: number]`

Implementation:

- `<Teleport to="body">` wrapping a `v-if="isOpen"` overlay
- Dark backdrop: `bg-black/90`
- `role="dialog"`, `aria-modal="true"`, `aria-label="Bildergalerie"`
- Close button: top-right, 48px+ touch target (w-12 h-12), `aria-label="Galerie schliessen"`
- Main image: centered, `<NuxtImg>` with `object-contain`, `max-h-full max-w-full`, `loading="eager"`
- Navigation arrows: Left/right, 48px+ touch targets, only shown when prev/next exists. `aria-label="Vorheriges Bild"` / `aria-label="Nachstes Bild"` (with umlauts)
- Thumbnail strip at bottom: same as Gallery but in lightbox context. Active thumbnail highlighted with white border, others at 60% opacity.
- Focus trap: Use `useFocusTrap` from `@vueuse/integrations/useFocusTrap`. Activate on `nextTick` after `isOpen` becomes true. Deactivate when closed.
- Keyboard: `@keydown` handler on the dialog div -- Escape closes, ArrowRight/ArrowLeft navigates. Bounds-check navigation (don't emit navigate beyond array bounds).
- Touch swipe: Use `useSwipe` from `@vueuse/core` on the image container. Left swipe = next, right swipe = prev. Bounds-check.

IMPORTANT: Wrap lightbox in `<ClientOnly>` in the parent Gallery component, NOT inside Lightbox itself. This prevents hydration mismatches.

**4. Create `app/components/rooms/Description.vue`**

"Mehr lesen" expandable description. Follow research example.

Props: `shortDescription: string`, `description: string`

- Show `shortDescription` always
- Full `description` hidden by default with `max-h-0 opacity-0` transitioning to `max-h-[1000px] opacity-100` when expanded
- Toggle button: "Mehr lesen" / "Weniger anzeigen" with chevron-down/up icon
- `aria-expanded` attribute on button
- Use `whitespace-pre-line` on full description to preserve paragraph breaks from YAML

**5. Create `app/components/rooms/Amenities.vue`**

Icon grid showing room specs and amenities. Follow research Pattern 5.

Props: `amenities: string[]`, `sizeM2?: number`, `maxGuests: number`, `beds: string`

Implementation:

- Import `amenityMap` from `~/utils/amenities`
- Grid layout: `grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4`
- First 3 items always: guests (lucide:users), beds (lucide:bed-double), size if present (lucide:ruler)
- Then dynamic amenities from the array, each showing its icon and label from amenityMap
- Each item: `flex items-center gap-3` with icon in `text-sage-600 shrink-0` and label text
- Fallback: if amenity not in map, show `lucide:check` icon and raw amenity string
  </action>
  <verify>
  Run `pnpm typecheck` to confirm all files have no TypeScript errors.
  Run `pnpm dev` -- no console errors related to these components (they are not yet rendered on a page, but imports should resolve).
  </verify>
  <done>
  useGallery composable manages gallery state with navigation and lightbox. Gallery component renders hero image + thumbnail strip. Lightbox component provides fullscreen overlay with focus trap, keyboard nav, and swipe. Description component supports "Mehr lesen" expand. Amenities component renders icon grid from amenityMap. All pass typecheck.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create pricing/extras/other-rooms components and assemble detail page</name>
  <files>
    app/components/rooms/PriceTable.vue
    app/components/rooms/Extras.vue
    app/components/rooms/OtherRooms.vue
    app/pages/zimmer/[slug].vue
  </files>
  <action>
**1. Create `app/components/rooms/PriceTable.vue`**

Pricing table with seasonal support. Follow research price table example.

Props: `pricing: PricingPeriod[]` where PricingPeriod has `label: string`, `dateRange?: string`, `rates: { occupancy: number, pricePerNight: number }[]`

Implementation:

- Responsive table: `overflow-x-auto` wrapper
- Table header: "Zeitraum", then dynamic columns based on max occupancy across all periods. For most rooms: "1 Person", "2 Personen". For Einzelzimmer with only 1-person rate, show just "1 Person".
- Dynamically determine column headers from the union of all occupancy values across all periods. Sort ascending.
- Each row: period label (bold) + optional dateRange (small, grey text below) + rate per occupancy column
- Rate cells: `{pricePerNight} EUR` (bold) + "pro Nacht" (small, grey below)
- Footer line: "Alle Preise inkl. MwSt." (PAngV compliance, LEGL-07)
- Border-bottom on each row for visual separation
- Use design system colors: charcoal for headings, grey for secondary text, sage-200 for borders

**2. Create `app/components/rooms/Extras.vue`**

Zusatzleistungen (add-ons) section.

Props: `extras: { name: string, description?: string, price: number, unit: string }[]`

Implementation:

- Section heading: "Zusatzleistungen" as h3
- List of extras, each as a flex row: name (+ optional description in small grey text), price + unit on the right
- Price format: `{price} EUR {unit}` (e.g., "10 EUR pro Person / Nacht")
- If extras array is empty, do not render anything (v-if on wrapper)
- Simple, clean list -- no cards or heavy styling. Border-bottom between items.

**3. Create `app/components/rooms/OtherRooms.vue`**

"Weitere Zimmer" section showing other available rooms.

Props: `rooms: Room[]` (the other rooms, already filtered by the page to exclude current)

Implementation:

- Section heading: "Weitere Zimmer" as h2
- Grid of RoomsCard components in compact mode: `grid grid-cols-2 sm:grid-cols-3 gap-4`
- Pass `compact` prop as `true` to each RoomsCard
- Each card shows: small image, room name, starting price
- This provides the visitor with every alternative without leaving the current room's detail page

**4. Create `app/pages/zimmer/[slug].vue`**

The room detail page assembling all components. This is the main deliverable of Phase 2.

Script setup:

- Get slug from `useRoute().params.slug`
- Fetch current room: `queryCollection('rooms').where('slug', '=', slug).first()`
- If no room found: `throw createError({ statusCode: 404, message: 'Zimmer nicht gefunden' })`
- Fetch other rooms: `queryCollection('rooms').where('slug', '!=', slug).order('sortOrder', 'ASC').all()`
- `useHead()` with dynamic meta: title `{room.name} | Pension Volgenandt` (under 60 chars), description from room's shortDescription (truncate to 155 chars if needed)

Template layout (top to bottom, per CONTEXT.md locked decision):

1. **Photos**: `<RoomsGallery>` with heroImage, heroImageAlt, gallery props
2. **Title**: h1 with room.name, room.category as subtitle/badge
3. **Description**: `<RoomsDescription>` with shortDescription and description
4. **Amenities**: `<RoomsAmenities>` with amenities, sizeM2, maxGuests, beds
5. **Price Table**: `<RoomsPriceTable>` with pricing array
6. **Extras**: `<RoomsExtras>` with extras array (only renders if non-empty)
7. **Weitere Zimmer**: `<RoomsOtherRooms>` with filtered other rooms

Section spacing: Use consistent vertical spacing between sections (e.g., `space-y-10` or `mt-10` per section).

Content width: Constrain to max-w-4xl or similar for readability, centered. Gallery can be full-width or constrained -- use judgment for best visual impact.

IMPORTANT accessibility: The gallery hero image must have `loading="eager"` and `fetchpriority="high"` as it is the LCP element. All other images are lazy-loaded.
</action>
<verify>
Run `pnpm dev` and navigate to `http://localhost:3000/zimmer/emils-kuhwiese` in the browser.

Verify:

1. Page renders without errors
2. Gallery shows hero image area + thumbnail strip below
3. Clicking a thumbnail opens the lightbox overlay
4. In lightbox: arrows navigate between images, Escape key closes, thumbnail strip at bottom works
5. Room name and category displayed as heading
6. "Mehr lesen" button expands/collapses full description
7. Amenity grid shows icons with German labels
8. Price table shows rates for 1 and 2 persons with "pro Nacht" and "inkl. MwSt."
9. Extras section lists Fruehstueck, Geniesser-Fruehstueck, Hund, BBQ-Set with prices
10. "Weitere Zimmer" section shows 6 other room cards
11. Clicking a card in "Weitere Zimmer" navigates to that room's detail page

Navigate to a few other rooms to confirm they all render correctly:

- `/zimmer/einzelzimmer` (should show only 1-person pricing)
- `/zimmer/balkonzimmer` (should list Balkon in amenities)
- `/zimmer/schoene-aussicht` (verify Ferienwohnung-specific amenities)

Run `pnpm typecheck` to confirm no TypeScript errors.
</verify>
<done>
Room detail page at `/zimmer/[slug]` renders complete room information: gallery with lightbox, expandable description, amenity icon grid, pricing table with PAngV compliance, extras section, and "Weitere Zimmer" cross-links. All 7 room pages render correctly. `pnpm typecheck` passes.
</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete room detail pages for all 7 rooms at `/zimmer/[slug]`. Each page includes: photo gallery with lightbox (hero + thumbnails + fullscreen overlay with keyboard/swipe navigation), room description with "Mehr lesen" expand, amenity icon grid, pricing table with seasonal support and VAT notice, extras/Zusatzleistungen section, and "Weitere Zimmer" cross-links to other rooms.
  </what-built>
  <how-to-verify>
1. Open `http://localhost:3000/zimmer/emils-kuhwiese`
2. Check the page layout top-to-bottom: Photos -> Title -> Description -> Amenities -> Prices -> Extras -> Weitere Zimmer
3. Click a gallery thumbnail -- lightbox should open with dark backdrop, large image, navigation arrows
4. In lightbox: press ArrowRight/ArrowLeft to navigate, Escape to close. On mobile: swipe left/right.
5. Verify thumbnail strip at bottom of lightbox highlights current image
6. Close lightbox and click "Mehr lesen" -- description should expand smoothly
7. Check amenity grid: icons should be clear, labels in German with proper umlauts
8. Check price table: "1 Person" and "2 Personen" columns, EUR amounts, "pro Nacht", "Alle Preise inkl. MwSt."
9. Check extras: Fruehstueck EUR 10, Geniesser-Fruehstueck EUR 15, Hund EUR 10, BBQ-Set EUR 10
10. Scroll to "Weitere Zimmer" -- should show 6 other rooms as compact cards
11. Click a "Weitere Zimmer" card -- navigate to that room's page
12. Visit `/zimmer/einzelzimmer` to verify it shows only 1-person pricing
13. Check mobile view (narrow browser): gallery thumbnails should scroll horizontally, layout should stack vertically
14. Verify the overall feel: clean, scannable, not overwhelming for 50-60 audience
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual, functional, or content issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. All 7 room detail pages render at `/zimmer/[slug]` without errors
2. Gallery: hero image visible, all thumbnails shown (never truncated), lightbox opens on click
3. Lightbox: keyboard navigation (arrows, Escape), touch swipe, focus trapped, close button 48px+
4. Amenities: Lucide icons with German labels, room specs (guests, beds, size) shown first
5. Pricing: Per-occupancy columns, "pro Nacht" unit, "Alle Preise inkl. MwSt." footer
6. Extras: Listed with prices and units, only shown if non-empty
7. Andere Zimmer: 6 other rooms shown as compact cards with links
8. `pnpm typecheck` passes with zero errors
9. No hydration warnings in browser console (lightbox wrapped in ClientOnly)
</verification>

<success_criteria>

- Room detail page at `/zimmer/[slug]` displays complete room data from YAML
- Gallery shows hero + all thumbnails, lightbox has full navigation (keyboard + swipe + arrows)
- All prices display with VAT included and "pro Nacht" unit (LEGL-07 PAngV compliance)
- Amenity icon grid uses Lucide icons with German labels
- "Weitere Zimmer" shows all other rooms for cross-navigation
- Page information order matches CONTEXT.md: Photos -> Title -> Description -> Amenities -> Prices + Extras -> Weitere Zimmer
- Detail pages work for all 7 rooms, including edge cases (Einzelzimmer with 1-person pricing)
- User has visually approved the complete room browsing experience
  </success_criteria>

<output>
After completion, create `.planning/phases/02-content-infrastructure-room-pages/02-03-SUMMARY.md`
</output>
